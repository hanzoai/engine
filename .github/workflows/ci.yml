on:
  schedule:
      - cron: '0 0 * * 1'
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

name: Continuous integration

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - name: Cargo check
        run: cargo check --manifest-path engine/Cargo.toml --locked --workspace --no-default-features

  check-metal:
    name: Check (metal)
    runs-on: macOS-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo check (metal)
        run: cargo check --manifest-path engine/Cargo.toml --locked --workspace --features metal

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
        rust: [stable]
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - name: Cargo test
        run: cargo test --manifest-path engine/Cargo.toml --locked -p mistralrs-core -p mistralrs-quant -p mistralrs-vision
        env:
          TESTS_HF_TOKEN: ${{ secrets.HF_TOKEN }}

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Cargo fmt
        run: cargo fmt --manifest-path engine/Cargo.toml --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Cargo clippy
        run: cargo clippy --manifest-path engine/Cargo.toml --locked --workspace --no-default-features --tests --examples -- -D warnings

  docs:
    name: Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo doc
        run: cargo doc --manifest-path engine/Cargo.toml --locked --workspace --no-default-features

  hanzo-engine:
    name: Build Hanzo Engine
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@stable
      - name: Build hanzo-engine
        run: cargo build --manifest-path engine/Cargo.toml --locked --package hanzo-engine --no-default-features --release
      - name: Test hanzo-engine
        run: cargo test --manifest-path engine/Cargo.toml --locked --package hanzo-engine --no-default-features
      - name: Verify binary
        run: |
          ./engine/target/release/hanzo-engine --version
          ./engine/target/release/hanzo-engine --help

  typos:
    name: Typos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Typos check with custom config file
        uses: crate-ci/typos@master
        with:
          config: .typos.toml

  msrv:
    name: MSRV Check (1.88)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: engine
      - uses: actions/checkout@v4
        with:
          repository: hanzoai/ml
          path: ml
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88.0"
      - name: Cargo check (MSRV)
        run: cargo check --manifest-path engine/Cargo.toml --locked --workspace --no-default-features
